#!/usr/local/bin/fish

shp2json $argv[1] |
geoproject 'd3.geoAlbersUsa().fitSize([975, 610], d)' |
ndjson-split 'd.features' |
ndjson-map 'd.id = d.properties.GEOID,
delete d.properties.STATEFP,
delete d.properties.COUNTYFP,
delete d.properties.COUNTYNS,
delete d.properties.AFFGEOID,
delete d.properties.GEOID,
delete d.properties.NAME,
delete d.properties.LSAD,
delete d.properties.ALAND,
delete d.properties.AWATER,
delete d.properties.COUNTYFP_1,
delete d.properties.AFFGEOID_1,
delete d.properties.NAME_1,
delete d.properties.County_S_1,
delete d.properties.Manufactur,
delete d.properties.PerCapit_2,
delete d.properties.Allindus_1,
delete d.properties.Construc_1,
delete d.properties.Informat_1,
delete d.properties.discussStd,
delete d.properties.GDP2018Std,
delete d.properties.FarmingStd,
delete d.properties.MiningStd,
d.properties.E_cmi10_00 = d.properties.E_cmi10_00 === -99999999 || d.properties.E_cmi10_00 === 0 ? undefined : d.properties.E_cmi10_00.toFixed(2),
d.properties.E_cmi10_80 = d.properties.E_cmi10_80 === -99999999 || d.properties.E_cmi10_80 === 0 ? undefined : d.properties.E_cmi10_80.toFixed(2),
d.properties.E_cmi10_81 = d.properties.E_cmi10_81 === -99999999 || d.properties.E_cmi10_81 === 0 ? undefined : d.properties.E_cmi10_81.toFixed(2),
d.properties.E_def_00_1 = d.properties.E_def_00_1 === -99999999 || d.properties.E_def_00_1 === 0 ? undefined : d.properties.E_def_00_1.toFixed(2),
d.properties.E_def_80_1 = d.properties.E_def_80_1 === -99999999 || d.properties.E_def_80_1 === 0 ? undefined : d.properties.E_def_80_1.toFixed(2),
d.properties.E_def_80_9 = d.properties.E_def_80_9 === -99999999 || d.properties.E_def_80_9 === 0 ? undefined : d.properties.E_def_80_9.toFixed(2),
d.properties.E_dry_00_1 = d.properties.E_dry_00_1 === -99999999 || d.properties.E_dry_00_1 === 0 ? undefined : d.properties.E_dry_00_1.toFixed(2),
d.properties.E_dry_80_1 = d.properties.E_dry_80_1 === -99999999 || d.properties.E_dry_80_1 === 0 ? undefined : d.properties.E_dry_80_1.toFixed(2),
d.properties.E_dry_80_9 = d.properties.E_dry_80_9 === -99999999 || d.properties.E_dry_80_9 === 0 ? undefined : d.properties.E_dry_80_9.toFixed(2),
d.properties.E_gw_00_19 = d.properties.E_gw_00_19 === -99999999 || d.properties.E_gw_00_19 === 0 ? undefined : d.properties.E_gw_00_19.toFixed(2),
d.properties.E_gw_80_19 = d.properties.E_gw_80_19 === -99999999 || d.properties.E_gw_80_19 === 0 ? undefined : d.properties.E_gw_80_19.toFixed(2),
d.properties.E_gw_80_99 = d.properties.E_gw_80_99 === -99999999 || d.properties.E_gw_80_99 === 0 ? undefined : d.properties.E_gw_80_99.toFixed(2),
d.properties.E_ht_00_19 = d.properties.E_ht_00_19 === -99999999 || d.properties.E_ht_00_19 === 0 ? undefined : d.properties.E_ht_00_19.toFixed(2),
d.properties.E_ht_80_19 = d.properties.E_ht_80_19 === -99999999 || d.properties.E_ht_80_19 === 0 ? undefined : d.properties.E_ht_80_19.toFixed(2),
d.properties.E_ht_80_99 = d.properties.E_ht_80_99 === -99999999 || d.properties.E_ht_80_99 === 0 ? undefined : d.properties.E_ht_80_99.toFixed(2),
d.properties.E_pet_00_1 = d.properties.E_pet_00_1 === -99999999 || d.properties.E_pet_00_1 === 0 ? undefined : d.properties.E_pet_00_1.toFixed(2),
d.properties.E_pet_80_1 = d.properties.E_pet_80_1 === -99999999 || d.properties.E_pet_80_1 === 0 ? undefined : d.properties.E_pet_80_1.toFixed(2),
d.properties.E_pet_80_9 = d.properties.E_pet_80_9 === -99999999 || d.properties.E_pet_80_9 === 0 ? undefined : d.properties.E_pet_80_9.toFixed(2),
d.properties.E_prc_00_1 = d.properties.E_prc_00_1 === -99999999 || d.properties.E_prc_00_1 === 0 ? undefined : d.properties.E_prc_00_1.toFixed(2),
d.properties.E_prc_80_1 = d.properties.E_prc_80_1 === -99999999 || d.properties.E_prc_80_1 === 0 ? undefined : d.properties.E_prc_80_1.toFixed(2),
d.properties.E_prc_80_9 = d.properties.E_prc_80_9 === -99999999 || d.properties.E_prc_80_9 === 0 ? undefined : d.properties.E_prc_80_9.toFixed(2),
d.properties.E_ro_00_19 = d.properties.E_ro_00_19 === -99999999 || d.properties.E_ro_00_19 === 0 ? undefined : d.properties.E_ro_00_19.toFixed(2),
d.properties.E_ro_80_19 = d.properties.E_ro_80_19 === -99999999 || d.properties.E_ro_80_19 === 0 ? undefined : d.properties.E_ro_80_19.toFixed(2),
d.properties.E_ro_80_99 = d.properties.E_ro_80_99 === -99999999 || d.properties.E_ro_80_99 === 0 ? undefined : d.properties.E_ro_80_99.toFixed(2),
d.properties.E_wet_00_1 = d.properties.E_wet_00_1 === -99999999 || d.properties.E_wet_00_1 === 0 ? undefined : d.properties.E_wet_00_1.toFixed(2),
d.properties.E_wet_80_1 = d.properties.E_wet_80_1 === -99999999 || d.properties.E_wet_80_1 === 0 ? undefined : d.properties.E_wet_80_1.toFixed(2),
d.properties.E_wet_80_9 = d.properties.E_wet_80_9 === -99999999 || d.properties.E_wet_80_9 === 0 ? undefined : d.properties.E_wet_80_9.toFixed(2),
d.properties.M_cmi10_00 = d.properties.M_cmi10_00 === -99999999 || d.properties.M_cmi10_00 === 0 ? undefined : d.properties.M_cmi10_00.toFixed(2),
d.properties.M_cmi10_8_ = d.properties.M_cmi10_8_ === -99999999 || d.properties.M_cmi10_8_ === 0 ? undefined : d.properties.M_cmi10_8_.toFixed(2),
d.properties.M_cmi10_80 = d.properties.M_cmi10_80 === -99999999 || d.properties.M_cmi10_80 === 0 ? undefined : d.properties.M_cmi10_80.toFixed(2),
d.properties.M_def_00_1 = d.properties.M_def_00_1 === -99999999 || d.properties.M_def_00_1 === 0 ? undefined : d.properties.M_def_00_1.toFixed(2),
d.properties.M_def_80_1 = d.properties.M_def_80_1 === -99999999 || d.properties.M_def_80_1 === 0 ? undefined : d.properties.M_def_80_1.toFixed(2),
d.properties.M_def_80_9 = d.properties.M_def_80_9 === -99999999 || d.properties.M_def_80_9 === 0 ? undefined : d.properties.M_def_80_9.toFixed(2),
d.properties.M_dry_00_1 = d.properties.M_dry_00_1 === -99999999 || d.properties.M_dry_00_1 === 0 ? undefined : d.properties.M_dry_00_1.toFixed(2),
d.properties.M_dry_80_1 = d.properties.M_dry_80_1 === -99999999 || d.properties.M_dry_80_1 === 0 ? undefined : d.properties.M_dry_80_1.toFixed(2),
d.properties.M_dry_80_9 = d.properties.M_dry_80_9 === -99999999 || d.properties.M_dry_80_9 === 0 ? undefined : d.properties.M_dry_80_9.toFixed(2),
d.properties.M_gw_00_19 = d.properties.M_gw_00_19 === -99999999 || d.properties.M_gw_00_19 === 0 ? undefined : d.properties.M_gw_00_19.toFixed(2),
d.properties.M_gw_80_19 = d.properties.M_gw_80_19 === -99999999 || d.properties.M_gw_80_19 === 0 ? undefined : d.properties.M_gw_80_19.toFixed(2),
d.properties.M_gw_80_99 = d.properties.M_gw_80_99 === -99999999 || d.properties.M_gw_80_99 === 0 ? undefined : d.properties.M_gw_80_99.toFixed(2),
d.properties.M_ht_00_19 = d.properties.M_ht_00_19 === -99999999 || d.properties.M_ht_00_19 === 0 ? undefined : d.properties.M_ht_00_19.toFixed(2),
d.properties.M_ht_80_19 = d.properties.M_ht_80_19 === -99999999 || d.properties.M_ht_80_19 === 0 ? undefined : d.properties.M_ht_80_19.toFixed(2),
d.properties.M_ht_80_99 = d.properties.M_ht_80_99 === -99999999 || d.properties.M_ht_80_99 === 0 ? undefined : d.properties.M_ht_80_99.toFixed(2),
d.properties.M_pet_00_1 = d.properties.M_pet_00_1 === -99999999 || d.properties.M_pet_00_1 === 0 ? undefined : d.properties.M_pet_00_1.toFixed(2),
d.properties.M_pet_80_1 = d.properties.M_pet_80_1 === -99999999 || d.properties.M_pet_80_1 === 0 ? undefined : d.properties.M_pet_80_1.toFixed(2),
d.properties.M_pet_80_9 = d.properties.M_pet_80_9 === -99999999 || d.properties.M_pet_80_9 === 0 ? undefined : d.properties.M_pet_80_9.toFixed(2),
d.properties.M_prc_00_1 = d.properties.M_prc_00_1 === -99999999 || d.properties.M_prc_00_1 === 0 ? undefined : d.properties.M_prc_00_1.toFixed(2),
d.properties.M_prc_80_1 = d.properties.M_prc_80_1 === -99999999 || d.properties.M_prc_80_1 === 0 ? undefined : d.properties.M_prc_80_1.toFixed(2),
d.properties.M_prc_80_9 = d.properties.M_prc_80_9 === -99999999 || d.properties.M_prc_80_9 === 0 ? undefined : d.properties.M_prc_80_9.toFixed(2),
d.properties.M_ro_00_19 = d.properties.M_ro_00_19 === -99999999 || d.properties.M_ro_00_19 === 0 ? undefined : d.properties.M_ro_00_19.toFixed(2),
d.properties.M_ro_80_19 = d.properties.M_ro_80_19 === -99999999 || d.properties.M_ro_80_19 === 0 ? undefined : d.properties.M_ro_80_19.toFixed(2),
d.properties.M_ro_80_99 = d.properties.M_ro_80_99 === -99999999 || d.properties.M_ro_80_99 === 0 ? undefined : d.properties.M_ro_80_99.toFixed(2),
d.properties.M_wet_00_1 = d.properties.M_wet_00_1 === -99999999 || d.properties.M_wet_00_1 === 0 ? undefined : d.properties.M_wet_00_1.toFixed(2),
d.properties.M_wet_80_1 = d.properties.M_wet_80_1 === -99999999 || d.properties.M_wet_80_1 === 0 ? undefined : d.properties.M_wet_80_1.toFixed(2),
d.properties.M_wet_80_9 = d.properties.M_wet_80_9 === -99999999 || d.properties.M_wet_80_9 === 0 ? undefined : d.properties.M_wet_80_9.toFixed(2),
d' > temp-map.ndjson
geo2topo -n counties=temp-map.ndjson |
toposimplify -p -1 -f |
topoquantize 1e5 |
topomerge -k 'd.id.slice(0,2)' states=counties |
topomerge --mesh -f 'a !== b' states=states > usa-topo.json